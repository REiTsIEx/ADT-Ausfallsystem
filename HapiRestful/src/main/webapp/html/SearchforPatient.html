<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Patientensuche</title>
<link rel="stylesheet" type="text/css"
	href="../css/SearchforPatientStyles.css">
<script type="text/javascript" src="../js/Methods.js"></script>

</head>


<body>

	<div>
		<ulBar> <liBar>
		<a href="HomeScreen.html"><b>Hauptseite</b></a></liBar> </ulBar>
	</div>

	<div class="header">
		<br>Patientensuche
	</div>

	<div class="row">
		<div class="col-3 menu">
			<ul>
				<li>Sozialversicherungsnummer: <br>
				<input type="text" placeholder="Optional" id="svnSearch"
					name="svnField"></li>

				<li>Nachname: <br>
				<input type="text" placeholder="Optional" id="lastnameSearch"
					name="lastnameField"></li>

				<li>Vorname: <br>
				<input type="text" placeholder="Optional" id="firstnameSearch"
					name="firstnameField"></li>

				<li class="button" onclick="searchPatient()">Suche nach Patient</li>

			</ul>

		</div>

		<div class="col-3 menu">

			<ul id="patientList">


			</ul>

		</div>
		<div class="col-3 menu">
			<ul class="clickedPatientList" id="clickedPatient"
				style="display: none">
				Persönliche Daten:
				<li>SVN-Nummer: <br> <input type="text"
					placeholder="Optional" id="svn_value" name="SVNField" value=></li>
				<li>Versicherung: <br> <input type="text"
					placeholder="Optional" id="insurance" name="insuranceField"></li>
				<li>Vorname: <br>
				<input type="text" placeholder="Optional" id="firstname"
					name="firstnameField"></li>
				<li>Nachname: <br>
				<input type="text" placeholder="Optional" id="lastname"
					name="lastnameField"></li>
				<li>Geburtsdatum: <br> <input type="date"
					placeholder="Optional" id="birthdate" name="birthdateField"></li>
				Anschrift
				<li>Straße: <br>
				<input type="text" placeholder="Optional" id="street"
					name="streetField"></li>
				<li>Stadt: <br>
				<input type="text" placeholder="Optional" id="city" name="cityField"></li>
				<li>Postleitzahl: <br>
				<input type="text" placeholder="Optional" id="plz" name="plzField"></li>
				<li>Land: <br>
				<input type="text" placeholder="Optional" id="country"
					name="countryField"></li>



				<li class="button" onclick="updatePatient()">Patientendaten
					überschreiben</li>
			</ul>
		</div>


	</div>


	<script src='http://code.jquery.com/jquery-2.1.4.min.js'></script>
	<script src='../js/fhir-client.js'></script>
	<script>
		var patientArray = [];
		var list = document.getElementById('patientList');
		function searchPatient() {
			patientArray = [];
			document.getElementById('clickedPatient').style.display = "none";
			$(patientList).empty();

			var entry = document.createElement('li')
			entry.className = "patientListbutton";
			entry.addEventListener("click", showPatient)

			var smart = new FHIR.client({
				//serviceUrl : "http://localhost:8080/Ausfallsystem/hapiservlet",
				serviceUrl : "https://fhir-open-api-dstu2.smarthealthit.org",
				
				auth : {
					type : 'none'
				}
			});

			if (svnSearch.value != "") {

				smart.api.search({
					type : "Patient",
					query : {
						identifier : {
							value : svnSearch.value
						}
					}
				}).then(
						function(patientList) {
							var arrayCount = patientList.data.total;

							patientList.data.entry.forEach(function(patient) {
								console.log(patientList);
								var nameg = patient.resource;
								var namePat = nameg.name[0];
								var familyName = namePat.family;
								var givenName = namePat.given;

								entry.appendChild(document
										.createTextNode(familyName + " "
												+ givenName));
								list.appendChild(entry);

							});

						});
			} else if (lastnameSearch.value != "") {

				smart.api
						.search({
							type : "Patient",
							query : {
								family : lastnameSearch.value,
								given : firstnameSearch.value
							}
						})
						.then(
								function(patientList) {
									

									if (patientList.data.total != 0) {
										//Legt die Länge des Array fest
										patientList.data.entry
												.forEach(function(patient) {
													
													var resource = patient.resource;
													var address = resource.address[0];
													var name = resource.name[0];
													singlePatient = {

														svn : resource.identifier[0].value,
														//careProvider : resource.careProvider[0].reference,
														gender : resource.gender,
														familyName : name.family,
														givenName : name.given,
														birthdate : resource.birthDate,
														street : address.line[0],
														postalCode : address.postalCode,
														city : address.city,
														country : address.country

													};
													entry
															.appendChild(document
																	.createTextNode(singlePatient.givenName
																			+ " "
																			+ singlePatient.familyName
																			+ " "
																			+ singlePatient.birthdate));
													list.appendChild(entry);
													patientArray
															.push(singlePatient);

													console
															.log(patientArray[0]);
												});
									} else {
										alert("Keine Ergebnisse");
									}
								});
			} else {
				alert("Bitte Nachname oder Sozialversicherungsnummer eingeben!")

			}
		}
		function showPatient() {

			var index = $(this).parent('li').index() + 1;

			console.log(JSON.stringify(patientArray[index].givenName));

			document.getElementById("firstname").defaultValue = patientArray[index].givenName;
			document.getElementById("lastname").defaultValue = patientArray[index].familyName;
			document.getElementById("svn_value").defaultValue = patientArray[index].svn;
			// document.getElementById("insurance").defaultValue = patientArray[index].careProvider;
			document.getElementById("birthdate").defaultValue = patientArray[index].birthdate;
			document.getElementById("street").defaultValue = patientArray[index].street;
			document.getElementById("city").defaultValue = patientArray[index].city;
			document.getElementById("plz").defaultValue = patientArray[index].postalCode;
			document.getElementById("country").defaultValue = patientArray[index].country;

			document.getElementById('clickedPatient').style.display = "block";
		}
	</script>

</body>


</html>